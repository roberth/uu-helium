#-----------------------------------------------------------------------
#  The Helium Compiler
#-----------------------------------------------------------------------

# make		     - build everything that is needed
# make clean	 - remove .hi and .o files
# make cleanag - remove all .hs files that are derivatives of .ag files

default: all

.PHONY : default compiler all libraries clean texthint 

VERSION = 1.7

#directories
HELIUMBINDIR = ../bin
OUTDIR = ../out
DOCDIR = ../out

#the main program you want to generate
MAIN	= helium
STRIP   = @STRIP@
EXE	= @EXEEXT@
HLINT   = hlint

# Installation paths
prefix      = @prefix@
basedir     = @prefix@/helium-$(VERSION)
exec_prefix = @exec_prefix@
bindir      = @bindir@          # Typically, this is in your path
hbindir     = $(basedir)/bin    # typically, this one is not. Used to support multiple versions.
libdir      = $(basedir)/lib
demodir     = $(basedir)/demo

status :
	@echo "*******************************************************************"
	@echo "Build process complete."
	@echo "Type \"make install\" to install."
	@echo "  Binaries will go into  $(bindir)"
	@echo "               and into  $(hbindir)"
	@echo "  Libraries will go into $(libdir)"
	@echo "  Demos will go into     $(demodir)"
	@echo "  To use this newly installed version, you might need to put a"
	@echo "  configuration file .hint.conf into your home directory: $(HOME)."
	@echo "  A default version of this configuration file, called hint.conf,"
	@echo "  can be found in $(basedir)."
	@echo "*******************************************************************"

HC	= @WithHc@
GHCWARN = -Wall
HC_OPTS = --make $(GHCWARN) -odir $(OUTDIR) -hidir $(OUTDIR) $(EXTRA_HC_OPTS)

AG      = @WithAG@ -P Syntax -P StaticAnalysis/StaticChecks -P StaticAnalysis/Inferencers -P CodeGeneration -P StaticAnalysis/Directives
AG_OPTS = -mscfr

# AG sources
AGSOURCES = \
     Syntax/UHA_Pretty.hs Syntax/UHA_OneLine.hs \
     StaticAnalysis/StaticChecks/StaticChecks.hs StaticAnalysis/Inferencers/TypeInferencing.hs \
     StaticAnalysis/Inferencers/KindInferencing.hs \
     CodeGeneration/CodeGeneration.hs \
     Syntax/UHA_Syntax.hs ModuleSystem/ExtractImportDecls.hs StaticAnalysis/Directives/TS_Syntax.hs \
     StaticAnalysis/Directives/TS_Apply.hs StaticAnalysis/Directives/TS_Analyse.hs \
     StaticAnalysis/Directives/TS_CoreSyntax.hs \
     StaticAnalysis/Directives/TS_ToCore.hs Parser/ResolveOperators.hs

# The main target
compiler: $(AGSOURCES)
	@echo "****************************************************"
	@echo "  Helium: the Helium compiler"
	@echo "****************************************************"
	$(HC)	-o $(HELIUMBINDIR)/$(MAIN)$(EXE) $(HC_OPTS) Main/Main.hs
	$(STRIP) $(HELIUMBINDIR)/$(MAIN)$(EXE)

all: ag compiler libraries texthint

libraries:
	@echo "****************************************************"
	@echo "  Libraries (with overloading)"
	@echo "****************************************************"
	cd ../lib; $(MAKE) 
	@echo "****************************************************"
	@echo "  Simple libraries (without overloading)"
	@echo "****************************************************"
	cd ../lib/simple; $(MAKE) 

texthint:
	@echo "****************************************************"
	@echo "  TextHint: the textual Helium interpreter"
	@echo "****************************************************"
	$(HC) -o $(HELIUMBINDIR)/texthint$(EXE) $(HC_OPTS) texthint/Main.hs
	$(STRIP) $(HELIUMBINDIR)/texthint$(EXE)

# AG sources

ag : $(AGSOURCES)

cleanag : 
	$(RM) $(AGSOURCES)

ifdef AG
Parser/ResolveOperators.hs : \
		Parser/ResolveOperators.ag Syntax/UHA_Syntax.ag
	# AG ResolveOperators
	$(AG) $(AG_OPTS) --self --module=Parser.ResolveOperators Parser/ResolveOperators.ag

Syntax/UHA_Pretty.hs : \
		Syntax/UHA_Pretty.ag Syntax/UHA_Syntax.ag
	# AG UHA_Pretty
	$(AG) $(AG_OPTS) --module=Syntax.UHA_Pretty Syntax/UHA_Pretty.ag

Syntax/UHA_OneLine.hs : \
		Syntax/UHA_OneLine.ag Syntax/UHA_Syntax.ag
	# AG UHA_OneLine
	$(AG) $(AG_OPTS) --self --module=Syntax.UHA_OneLine Syntax/UHA_OneLine.ag

StaticAnalysis/StaticChecks/StaticChecks.hs : \
		StaticAnalysis/StaticChecks/StaticChecks.ag \
		StaticAnalysis/StaticChecks/KindChecking.ag \
                StaticAnalysis/StaticChecks/TopLevelErrors.ag \
                StaticAnalysis/StaticChecks/MiscErrors.ag \
                StaticAnalysis/StaticChecks/Warnings.ag \
		StaticAnalysis/StaticChecks/ExportErrors.ag \
                StaticAnalysis/StaticChecks/Collect.ag \
                StaticAnalysis/StaticChecks/HeliumPartialSyntax.ag \
                StaticAnalysis/StaticChecks/Scope.ag \
                StaticAnalysis/StaticChecks/ScopeErrors.ag \
		Syntax/UHA_Syntax.ag 
                
	# AG StaticAnalysis
	$(AG) $(AG_OPTS) --self --module=StaticAnalysis.StaticChecks.StaticChecks StaticAnalysis/StaticChecks/StaticChecks.ag

StaticAnalysis/Inferencers/TypeInferencing.hs : \
		StaticAnalysis/Inferencers/TypeInferencing.ag \
                StaticAnalysis/Inferencers/TypeInferenceRules.ag \
                StaticAnalysis/Inferencers/TypeInferenceOverloading.ag \
                StaticAnalysis/Inferencers/TypeInferenceCollect.ag \
                StaticAnalysis/Inferencers/TypeInferenceInfo.ag \
                StaticAnalysis/Inferencers/PatternMatchWarnings.ag \
                StaticAnalysis/Inferencers/LocalInfo.ag \
                StaticAnalysis/Inferencers/GlobalInfo.ag \
                StaticAnalysis/StaticChecks/HeliumPartialSyntax.ag \
		Syntax/UHA_Syntax.ag \
                StaticAnalysis/StaticChecks/Scope.ag\
                StaticAnalysis/Directives/TS_PatternMatching.ag
                
	# AG TypeInferencing
	$(AG) $(AG_OPTS) --self --module=StaticAnalysis.Inferencers.TypeInferencing StaticAnalysis/Inferencers/TypeInferencing.ag

StaticAnalysis/Inferencers/KindInferencing.hs : \
		StaticAnalysis/Inferencers/KindInferencing.ag \
                Syntax/UHA_Syntax.ag \
                
	# AG TypeInferencing
	$(AG) $(AG_OPTS) --self --module=StaticAnalysis.Inferencers.KindInferencing StaticAnalysis/Inferencers/KindInferencing.ag

CodeGeneration/CodeGeneration.hs : \
		CodeGeneration/CodeGeneration.ag \
		Syntax/UHA_Syntax.ag CodeGeneration/ToCoreModule.ag CodeGeneration/ToCoreDecl.ag \
		CodeGeneration/ToCoreExpr.ag CodeGeneration/ToCorePat.ag CodeGeneration/ToCoreName.ag
	# AG CodeGeneration
	$(AG) $(AG_OPTS) --self --module=CodeGeneration.CodeGeneration CodeGeneration/CodeGeneration.ag

Syntax/UHA_Syntax.hs : Syntax/UHA_Syntax.ag
	# AG UHA_Syntax
	$(AG) -dmr --module=Syntax.UHA_Syntax Syntax/UHA_Syntax.ag

ModuleSystem/ExtractImportDecls.hs : \
		ModuleSystem/ExtractImportDecls.ag CodeGeneration/ToCoreName.ag Syntax/UHA_Syntax.ag
	# AG ExtractImportDecls
	$(AG) $(AG_OPTS) --self --module=ModuleSystem.ExtractImportDecls ModuleSystem/ExtractImportDecls.ag
        
StaticAnalysis/Directives/TS_Syntax.hs : \
	StaticAnalysis/Directives/TS_Syntax.ag
	# AG TS_Syntax
	$(AG) -dmr --module=StaticAnalysis.Directives.TS_Syntax StaticAnalysis/Directives/TS_Syntax.ag

StaticAnalysis/Directives/TS_Analyse.hs : \
        StaticAnalysis/Directives/TS_Syntax.ag \
        StaticAnalysis/Directives/TS_Collect.ag \
        StaticAnalysis/Directives/TS_Analyse.ag \
        Syntax/UHA_Syntax.ag 
	# AG TS_Analyse
	$(AG) $(AG_OPTS) --self --module=StaticAnalysis.Directives.TS_Analyse StaticAnalysis/Directives/TS_Analyse.ag

StaticAnalysis/Directives/TS_Apply.hs : \
        StaticAnalysis/Directives/TS_Syntax.ag \
        StaticAnalysis/Directives/TS_Collect.ag \
        StaticAnalysis/Directives/TS_Apply.ag \
        StaticAnalysis/Directives/TS_CoreSyntax.ag \
        Syntax/UHA_Syntax.ag \
	# AG TS_Syntax
	$(AG) -mscf --module=StaticAnalysis.Directives.TS_Apply StaticAnalysis/Directives/TS_Apply.ag

StaticAnalysis/Directives/TS_CoreSyntax.hs : \
	StaticAnalysis/Directives/TS_CoreSyntax.ag \
	# AG TS_CoreSyntax
	$(AG) -md --module=StaticAnalysis.Directives.TS_CoreSyntax StaticAnalysis/Directives/TS_CoreSyntax.ag

StaticAnalysis/Directives/TS_ToCore.hs : \
        StaticAnalysis/Directives/TS_Syntax.ag \
        StaticAnalysis/Directives/TS_Collect.ag \
        StaticAnalysis/Directives/TS_ToCore.ag \
        Syntax/UHA_Syntax.ag \
        Syntax/UHA_OneLine.ag 
	# AG TS_Syntax
	$(AG) -mscrf --self --module=StaticAnalysis.Directives.TS_ToCore StaticAnalysis/Directives/TS_ToCore.ag                 
endif

report:
	make cleanag # do not analyze output of AG files
	$(HLINT) --report=$(DOCDIR)/report.html .

# Clean	up
clean:
	$(RM) -rf $(OUTDIR)
	$(RM) ../lib/*.lvm
	$(RM) ../lib/simple/*.lvm
	$(RM) $(HELIUMBINDIR)/$(MAIN)$(EXE)
	$(RM) $(HELIUMBINDIR)/texthint$(EXE)
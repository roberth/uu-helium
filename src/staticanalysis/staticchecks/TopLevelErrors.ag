-------------------------------------------------------------------------------
--
--   *** The Helium Compiler : Static Analysis ***
--               ( Bastiaan Heeren )
--
-- TopLevelErrors.ag : Collect static errors that are detected at top-level. 
--
------------------------------------------------------------------------------

imports {
import List       ( sort, group, nubBy )
import UHA_Utils  ( getNameName, getPatRange, getStatementRange )
import Utils      ( fst3 )
import Similarity ( similar )
}

------------------------------------------------------------------------------
-- All Top-Level Errors

SEM Module
  | Module   loc . topLevelErrors = concat [ @typeConstructorErrors  
                                           , @valueConstructorErrors
                                           , @fixityErrors
                                           , @fixityButNoFunDefErrors
                                           , @recursiveTypeSynonymErrors
                                           , @wrongFileNameErrors
                                           ]
                 
------------------------------------------------------------------------------
-- duplicated type constructors

SEM Module 
  | Module   loc . typeConstructorErrors = makeDuplicated TypeConstructor @duplicatedTypeConstructors

------------------------------------------------------------------------------
-- duplicated value constructors

SEM Module
  | Module   loc . valueConstructorErrors = makeDuplicated Constructor @duplicatedValueConstructors
  
------------------------------------------------------------------------------
-- duplicated fixity declarations

SEM Module
  | Module   loc . fixityErrors = makeDuplicated Fixity @duplicatedFixities
                 . (duplicatedFixities,correctFixities) = let (xs,ys) = partition ((>1) . length) . group . sort $ (map fst @body.operatorFixities)
                                                          in (xs,map head ys)

------------------------------------------------------------------------------
-- fixity declarations without a definition

SEM Module
  | Module   loc . fixityButNoFunDefErrors = let list = nub (@body.declVarNames ++ @allValueConstructors)
                                             in makeNoFunDef Fixity (filter (`notElem` list) @correctFixities) list
                                                                                                         
------------------------------------------------------------------------------
-- recursive type synonyms

SEM Module
  | Module   loc . recursiveTypeSynonymErrors = map RecursiveTypeSynonyms @recursiveTypeSynonyms

------------------------------------------------------------------------------
-- wrong file name (does not match the module name)

SEM Module
  | Module  loc . wrongFileNameErrors = let moduleString = getNameName  @moduleName
                                            moduleRange  = getNameRange @moduleName
                                        in if moduleString == "" || @lhs.baseName == moduleString
                                          then []
                                          else [ WrongFileName @lhs.baseName moduleString moduleRange ]
                . moduleName     = case @name.self of 
                                      MaybeName_Just name -> name 
                                      MaybeName_Nothing   -> Name_Identifier noRange [] ""                                    
                . fileName       = Name_Identifier noRange [] @lhs.baseName 
